#!/usr/bin/env ruby
require 'fileutils'
include FileUtils
require 'accel'
opt = Accel::optparse! {
  xcode false
  ninja false
  make false
  llvm "/opt/llvm34"
}

ENV['CC'] = "#{opt.llvm}/bin/clang"
ENV['CXX'] = "#{opt.llvm}/bin/clang++"
ENV['CXXFLAGS'] = "-std=c++11 -g"

generators = []
generators << "Xcode" if opt.xcode
generators << "Ninja" if opt.ninja
generators << "Make" if opt.make

generators.each do |g|
  pwd = Dir.pwd
  dir = "build/#{g.downcase}"
  mkdir_p dir
  cd(dir) {
    if g[/Make/]
      args = [
        %Q[-G"Unix Makefiles"],
        "-DLLVM_PREFIX=#{opt.llvm}",
        pwd
      ]
      system "cmake #{args.join(' ')}"
    else
      system "cmake -G #{g} -DLLVM_PREFIX=#{opt.llvm} #{pwd}"
    end
  }
end
